!function(){"use strict";function e(e,r,n,t){function i(e){var t=r.get("$http"),i={method:"GET",url:n.O365CONFIG.SHAREPOINT_URL,headers:{"X-UserType":n.USER_TYPE.O365}};t(i).success(function(r){return Utilities.isNotUndefinedOrNull(r.webUrl)?void e(r.webUrl):void e(null)}).error(function(){e(null)})}function o(i){var o=r.get("$http"),l={method:"GET",url:n.O365CONFIG.DISCOVERY_URL,headers:{"X-UserType":n.USER_TYPE.O365}};o(l).success(function(r){for(var o=0;o<r.value.length;++o)if("MyFiles"===r.value[o].capability&&"v2.0"===r.value[o].serviceApiVersion){var l={};return l.resource=r.value[o].serviceResourceId,l.url=r.value[o].serviceEndpointUri,void i(l)}u(),t.show(n.NOTIFICATION.INVALIDSUBSCRIPTION),e.info(String.format("o365UserService.DiscoverServiceEndpoint - Invalid resource")),i(null)}).error(function(){u(),t.show(n.NOTIFICATION.INVALIDSUBSCRIPTION),i(null)})}function u(){var e=r.get("userService");e.clearToken()}function l(r){var t={},i=s(r);return i&&i.hasOwnProperty("aud")&&(i.aud.toLowerCase()===n.O365CONFIG.CLIENT_ID.toLowerCase()?(i.hasOwnProperty("upn")?t.email=i.upn:i.hasOwnProperty("email")&&(t.email=i.email),i.hasOwnProperty("puid")&&(t.puid=i.puid),i.hasOwnProperty("tid")&&(t.tid=i.tid)):e.error("IdToken has invalid aud field")),t}function s(r){var n=O(r);if(!n)return null;try{var t=n.JWSPayload,i=a(t);return i?JSON.parse(i):(this._logstatus("The returned id_token could not be base64 url safe decoded."),null)}catch(o){e.error("The returned id_token could not be decoded: "+o.stack)}return null}function a(e){return e=e.replace(/-/g,"+").replace(/_/g,"/"),window.atob?decodeURIComponent(escape(window.atob(e))):null}function O(r){var n=/^([^\.\s]*)\.([^\.\s]+)\.([^\.\s]*)$/,t=n.exec(r);if(!t||t.length<4)return e.error("The returned id_token is not parseable."),null;var i={header:t[1],JWSPayload:t[2],JWSSig:t[3]};return i}this.type=n.USER_TYPE.O365,this.getConfig=function(){var e={url:n.O365CONFIG.INSTANCE+"token",params:{client_id:n.O365CONFIG.CLIENT_ID,client_secret:n.O365CONFIG.CLIENT_SECRET,redirect_uri:n.O365CONFIG.REDIRECT_URI,resource:n.O365CONFIG.DISCOVERY_RESOURCE},resource:n.O365CONFIG.DISCOVERY_RESOURCE,loginUrl:n.O365CONFIG.INSTANCE+"authorize?response_type=code&client_id="+n.O365CONFIG.CLIENT_ID+"&redirect_uri="+n.O365CONFIG.REDIRECT_URI,logoutUrl:n.O365CONFIG.LOGOUT_URI};return e},this.getResourceForEndpoint=function(e){var r=null;if(Utilities.isUndefinedOrNull(e))return r;for(var t in n.O365CONFIG.ENDPOINTS)n.O365CONFIG.ENDPOINTS.hasOwnProperty(t)&&e.indexOf(t)>-1&&(r=n.O365CONFIG.ENDPOINTS[t]);return r},this.lookupUserInfo=function(e,r){var t=l(e.id_token);o(function(e){t.serviceInfo=e,i(function(e){t.sharePointUrl=Utilities.isUndefinedOrNull(e)?n.LINKS.APP.SHAREPOINT_DEFAULT:e,r(t)})})}}angular.module("app.user").service("o365UserService",["$log","$injector","constants","notification",e])}();