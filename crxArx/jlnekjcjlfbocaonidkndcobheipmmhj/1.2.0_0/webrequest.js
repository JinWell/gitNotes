function onFilterChange(){onFilterChangeTimeout=null,chrome.webRequest.handlerBehaviorChanged()}function onBeforeRequest(e){if(e.tabId==-1)return{};var r=e.type;if(0!=e.frameId||e.tabId in frames||"object"!=r||(r="main_frame"),"main_frame"!=r&&"sub_frame"!=r||recordFrame(e.tabId,e.frameId,e.parentFrameId,e.url),"main_frame"==r)return{};r="sub_frame"==r?"SUBDOCUMENT":r.toUpperCase();var t="SUBDOCUMENT"!=r?e.frameId:e.parentFrameId,a=checkRequest(r,e.tabId,e.url,t);return FilterNotifier.triggerListeners("filter.hitCount",a,0,0,e.tabId),a instanceof BlockingFilter?{cancel:!0}:a instanceof RedirectFilter?{redirectUrl:a.redirect(e.url)}:{}}function onHeadersReceived(e){if(e.tabId!=-1){var r=e.type;if("main_frame"==r||"sub_frame"==r){var t=getFrameUrl(e.tabId,e.frameId);if(t==e.url){for(var a=null,i=null,n=0;n<e.responseHeaders.length;n++){var o=e.responseHeaders[n];if("x-adblock-key"==o.name.toLowerCase()&&o.value){var s=o.value.indexOf("_");if(s>=0){var a=o.value.substr(0,s),i=o.value.substr(s+1);break}}}if(a){var u=null;"sub_frame"==r&&(u=getFrameUrl(e.tabId,e.parentFrameId)),u||(u=t);var f=extractHostFromURL(u),l=defaultMatcher.matchesByKey(t,a.replace(/=/g,""),f);if(l){var d=new URI(t),m=d.asciiHost;d.port>0&&(m+=":"+d.port);var c=[d.path.replace(/#.*/,""),m,window.navigator.userAgent];verifySignature(a,i,c.join("\0"))&&(frames[e.tabId][e.frameId].keyException=!0)}}}}}}function recordFrame(e,r,t,a){e in frames||(frames[e]={}),frames[e][r]={url:a,parent:t}}function getFrameData(e,r){return e in frames&&r in frames[e]?frames[e][r]:r>0&&e in frames&&0 in frames[e]?frames[e][0]:null}function getFrameUrl(e,r){var t=getFrameData(e,r);return t?t.url:null}function forgetTab(e){delete frames[e]}function checkRequest(e,r,t,a){if(isFrameWhitelisted(r,a))return!1;var i=getFrameUrl(r,a);if(!i)return!1;var n=extractHostFromURL(t),o=extractHostFromURL(i),s=isThirdParty(n,o);return defaultMatcher.matchesAny(t,e,o,s)}function isFrameWhitelisted(e,r,t){for(var a=r,i=getFrameData(e,a);i;){var n=i;a=n.parent,i=getFrameData(e,a);var o=n.url,s=i?i.url:o;if("keyException"in n||isWhitelisted(o,s,t))return!0}return!1}var FilterNotifier=require("filterNotifier").FilterNotifier;chrome.webRequest.onBeforeRequest.addListener(onBeforeRequest,{urls:["http://*/*","https://*/*"]},["blocking"]),chrome.webRequest.onHeadersReceived.addListener(onHeadersReceived,{urls:["http://*/*","https://*/*"]},["responseHeaders"]),chrome.tabs.onRemoved.addListener(forgetTab);var onFilterChangeTimeout=null,importantNotifications={"filter.added":!0,"filter.removed":!0,"filter.disabled":!0,"subscription.added":!0,"subscription.removed":!0,"subscription.disabled":!0,"subscription.updated":!0,load:!0};FilterNotifier.addListener(function(e){e in importantNotifications&&(null!=onFilterChangeTimeout&&window.clearTimeout(onFilterChangeTimeout),onFilterChangeTimeout=window.setTimeout(onFilterChange,2e3))});var frames={};